** setup **

Using mysql we need to creat the following tables.  The must be reabable by django, i.e. configure with the same database user used in django. 

  # RBTODO add foreign key constratin on datasets/metadata

  create database ocptilecache;
  use ocptilecache
  CREATE TABLE contents ( highkey BIGINT, lowkey BIGINT, filename varchar(255), reftime TIMESTAMP, PRIMARY KEY ( highkey, lowkey)); 
  CREATE TABLE datasets ( dataset VARCHAR(255) PRIMARY KEY, datasetid INT UNIQUE AUTO_INCREMENT, ximagesz INT, yimagesz INT, zimagesz INT, xoffset INT, yoffset INT, zoffset INT, xvoxelres DOUBLE, yvoxelres DOUBLE, zvoxelres DOUBLE, scalingoption INT, scalinglevels INT);
  CREATE TABLE metadata ( numtiles BIGINT);
  CREATE TABLE fetching ( url VARCHAR(255) PRIMARY KEY );
  INSERT INTO metadata (numtiles) VALUES (0);

  # And a database for django
  create database ocptilecache_django;

Make directories for logging. It has to have permission for the Web server (www-data or your user for the development server)

  mkdir /var/log/ocptilecache
  chown www-data /var/log/ocptilecache 
  mkdir /var/log/celery
  chown www-data /var/log/celery 

Starting the celery dev server.  The service uses two queues.  For testing you can start them together.  For deployments, we should have them running separately as daemons.

  python manage.py celery worker --loglevel=info -Q celery,reclaim

If this works, stop the dev server.

Follow all of the instructions in the ocptilecache/setup directory.  Then:

Restart all the services

  sudo /etc/init.d/uwsgi restart ocptilecache
  sudo /etc/init.d/supervisor restart 
  sudo /etc/init.d/nginx restart 

And check their status

  sudo /etc/init.d/uwsgi status ocptilecache
  sudo /etc/init.d/supervisor status 
  sudo /etc/init.d/nginx status 

If all are running you should be good to go.

** Configuring in CATMAID **

Create a stack to a remote site.  It must have the following properties:
  * Image base = http://localhost/ocpcatmaid/[token]/
  * File extension = png
  * Tile width = 512
  * Tile height = 512

** Configuration instructions for ubuntu nginx/uwsgi/supervisor **

  * uWSGI: ocpcatmaid.ini goes in /etc/uwsgi/apps-enabled
  * supervisord: celery.ini and reclaim.ini go in /etc/supervisor/conf.d/
  * nginx: add the portions of default.nginx to /etc/nginx/sites-enabled/default
  * apache: add the snippet to /etc/apache2/sites-enabled
